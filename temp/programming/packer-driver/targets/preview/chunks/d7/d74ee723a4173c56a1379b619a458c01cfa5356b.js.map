{"version":3,"sources":["file:///D:/Project/cocos/test/assets/Mass.ts"],"names":["_decorator","Component","MeshRenderer","Vec3","Vec4","ccclass","property","Mass","Number","mat","followPos","massVelocity","max","min","bound","_delayMoveTime","_curTime","_moveDir","myPos","vec4FollowPos","_moveStep","_massVec","_forceDir","start","getComponent","sharedMaterial","node","position","clone","model","modelBounds","halfExtents","pass","passes","setUniform","getHandle","y","x","z","update","deltaTime","force","GetMainForce","add","GetDampingForce","multiplyScalar","SetMatData","subtract","stiffness","damping","vec32vec4","vec3","vec4","w"],"mappings":"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","sourcesContent":["import { _decorator, Component, Material, MeshRenderer, Node, Vec3, Vec4 } from 'cc';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('Mass')\r\nexport class Mass extends Component {\r\n    private mat: Material;\r\n    private followPos: Vec3;//从动点位置\r\n    private massVelocity: Vec3 //从动点速度\r\n    @property(Number)\r\n    public stiffness = 60.0;//劲度系数\r\n    @property(Number)\r\n    public damping = 2.0;//阻尼系数\r\n\r\n    private max: number;\r\n    private min: number;//模型在模型空间最高, 最低点的y值\r\n    private bound: Vec3;\r\n    private _delayMoveTime = 0.5;\r\n    private _curTime = 0;\r\n    private _moveDir: Vec3;\r\n    private myPos: Vec4;\r\n    private vec4FollowPos: Vec4;\r\n    private _moveStep = 0.01;\r\n    private _massVec:Vec3=new Vec3();\r\n    private _forceDir:Vec3=new Vec3();\r\n    start() {\r\n        this.followPos = new Vec3(0.0, 0.0, 0.0);\r\n        this.massVelocity = new Vec3(0.0, 0.0, 0.0);\r\n\r\n        this.mat = this.getComponent(MeshRenderer).sharedMaterial;\r\n        this.followPos = this.node.position.clone();//虚拟抽象一个从动点\r\n\r\n        //距离轴心的物体空间距离\r\n        var bound = this.getComponent(MeshRenderer).model.modelBounds.halfExtents;\r\n        this.bound = bound;\r\n        // this.max = bound.center.y*2.0;\r\n\r\n        this._moveDir = new Vec3(this._moveStep, 2, 0);\r\n        var pass = this.mat.passes[0];\r\n        pass.setUniform(pass.getHandle(\"_MeshH\"), bound.y * 2);//模型总高度\r\n\r\n        this.myPos = new Vec4(this.node.position.x, this.node.position.y, this.node.position.z, 1.0);\r\n    }\r\n\r\n    update(deltaTime: number) {\r\n        if (this._curTime > this._delayMoveTime) {\r\n            this._curTime = 0;\r\n            this._moveStep = -this._moveStep;\r\n        }\r\n        this._curTime += deltaTime;\r\n        this._moveDir.x += this._moveStep;\r\n        this.node.position = this._moveDir;\r\n        //进行一些受力, 加速度, 速度, 路程, 运动 的数值计算\r\n        var force = this.GetMainForce();//弹力\r\n\r\n        force.add(this.GetDampingForce());//阻力\r\n        this.massVelocity.add(force.multiplyScalar(deltaTime));//将固定质量为1, 则force数值等于加速度数值\r\n       \r\n        Vec3.multiplyScalar(this._massVec,this.massVelocity,deltaTime)\r\n        this.followPos.add(this._massVec);//从动点的移动\r\n        //为shader传入数据\r\n        this.SetMatData();\r\n    }\r\n    private GetMainForce(): Vec3 {\r\n        //胡克定律\r\n        Vec3.subtract(this._forceDir,this.node.position,this.followPos)\r\n        return this._forceDir.multiplyScalar(this.stiffness);\r\n    }\r\n    private GetDampingForce(): Vec3 {\r\n        Vec3.multiplyScalar(this._massVec,this.massVelocity,-this.damping)\r\n        return this._massVec;//弹簧阻尼\r\n    }\r\n    private SetMatData(): void {\r\n        var pass = this.mat.passes[0];\r\n\r\n        this.myPos = this.vec32vec4(this.node.position, this.myPos);\r\n        this.vec4FollowPos = this.vec32vec4(this.followPos, this.vec4FollowPos);\r\n        pass.setUniform(pass.getHandle(\"_MainPos\"), this.myPos);//主动点\r\n        pass.setUniform(pass.getHandle(\"_FollowPos\"), this.vec4FollowPos);//从动点\r\n        \r\n        pass.setUniform(pass.getHandle(\"_W_Bottom\"), this.node.position.y - this.bound.y);//模型最低点y值\r\n    }\r\n    private vec32vec4(vec3: Vec3, vec4: Vec4) {\r\n        if (!vec4) {\r\n            vec4 = new Vec4()\r\n        }\r\n        vec4.x = vec3.x;\r\n        vec4.y = vec3.y;\r\n        vec4.z = vec3.z;\r\n        vec4.w = 1.0;\r\n        return vec4;\r\n    }\r\n}\r\n\r\n\r\n"]}